<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blast Damage Map Viewer</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    /* 높이는 JS에서 데이터 비율로 동적으로 설정 */
    #plot { width: 100%; max-width: 900px; }
    label { margin-right: 20px; }
  </style>
</head>
<body>

<h2>Spatially Averaged Blast Damage Map</h2>

<label>
TNT charge:
<select id="charge"></select>
</label>

<label>
Threshold:
<input type="range" id="thr" min="0" max="1" step="0.01" value="0.50">
<span id="thrVal">0.50</span>
</label>

<div id="plot"></div>

<script>
const chargeSel = document.getElementById("charge");
const thr = document.getElementById("thr");
const thrVal = document.getElementById("thrVal");
const plotDiv = document.getElementById("plot");

// ===== 축 범위 (cm) =====
const X_RANGE = [0, 45];
const Y_RANGE = [10, 100];

// ===== 데이터 비율(세로/가로) =====
const X_SPAN = X_RANGE[1] - X_RANGE[0];   // 45
const Y_SPAN = Y_RANGE[1] - Y_RANGE[0];   // 90
const ASPECT = Y_SPAN / X_SPAN;           // 2.0

// ===== 파일 목록 =====
const files = [
  "m0p1","m0p2","m0p3","m0p4","m0p5",
  "m0p6","m0p7","m0p8","m0p9","m1p0"
];

files.forEach(f => {
  const opt = document.createElement("option");
  opt.value = f;
  opt.text = f.replace("m","").replace("p",".") + " kg";
  chargeSel.appendChild(opt);
});

// ✅ 플롯 div 높이를 데이터 비율에 맞춰 자동 설정
function setPlotHeight() {
  const w = plotDiv.clientWidth;               // 실제 렌더 폭(px)
  const h = Math.round(w * ASPECT);            // 1:1 유지하려면 세로가 2배 필요
  plotDiv.style.height = `${h}px`;
}

async function loadCSV(name) {
  const r = await fetch(`data/${name}.csv`);
  if (!r.ok) throw new Error(`Cannot load data/${name}.csv`);
  const text = await r.text();

  const rows = text.trim().split(/\r?\n/);
  const head = rows[0].split(",");
  const ix = head.indexOf("x_cm");
  const iy = head.indexOf("y_cm");
  const id = head.indexOf("damage");
  if (ix < 0 || iy < 0 || id < 0) {
    throw new Error("CSV must have columns: x_cm,y_cm,damage");
  }

  const data = rows.slice(1).map(r => r.split(",").map(Number));
  const xs = [...new Set(data.map(r => r[ix]))].sort((a,b)=>a-b);
  const ys = [...new Set(data.map(r => r[iy]))].sort((a,b)=>a-b);

  const z = ys.map(() => xs.map(() => null));
  data.forEach(r => {
    const x = r[ix], y = r[iy], d = r[id];
    if (Number.isFinite(x) && Number.isFinite(y) && Number.isFinite(d)) {
      z[ys.indexOf(y)][xs.indexOf(x)] = d;
    }
  });

  return {xs, ys, z};
}

function mask(z, t) {
  return z.map(row =>
    row.map(v => (v == null || Number.isNaN(v)) ? null : (v >= t ? 1 : 0))
  );
}

async function draw() {
  // 1) 먼저 div 높이를 맞춰서 "처음부터 꽉 차게"
  setPlotHeight();

  thrVal.textContent = Number(thr.value).toFixed(2);

  const {xs, ys, z} = await loadCSV(chargeSel.value);
  const t = Number(thr.value);
  const m = mask(z, t);

  await Plotly.newPlot(plotDiv, [
    // base damage map: 0 white, 1 black
    {
      type: "heatmap",
      x: xs,
      y: ys,
      z: z,
      colorscale: [
        [0.0, "rgb(255,255,255)"],
        [1.0, "rgb(0,0,0)"]
      ],
      zmin: 0,
      zmax: 1,
      colorbar: { title: "Damage" }
    },
    // threshold overlay: red for exceed
    {
      type: "heatmap",
      x: xs,
      y: ys,
      z: m,
      showscale: false,
      zmin: 0,
      zmax: 1,
      colorscale: [
        [0.0, "rgba(0,0,0,0)"],
        [1.0, "rgba(255,0,0,0.55)"]
      ]
    }
  ], {
    xaxis: {
      title: "X-coordinate (cm)",
      range: X_RANGE,
      tickmode: "linear",
      tick0: 0,
      dtick: 5,
      showgrid: true,
      gridcolor: "rgba(0,0,0,0.15)"
    },
    yaxis: {
      title: "Y-coordinate (cm)",
      range: Y_RANGE,
      tickmode: "linear",
      tick0: 10,
      dtick: 10,
      showgrid: true,
      gridcolor: "rgba(0,0,0,0.15)",
      // ✅ 1 cm = 1 cm 강제
      scaleanchor: "x",
      scaleratio: 1
    },
    margin: { l: 80, r: 20, t: 20, b: 60 }
  }, {responsive: true});

  // 2) 렌더 직후 한 번 더 resize (브라우저 레이아웃 확정 후)
  Plotly.Plots.resize(plotDiv);
}

// 이벤트
chargeSel.onchange = () => draw().catch(console.error);
thr.oninput = () => draw().catch(console.error);

// 창 크기 변하면 높이도 다시 맞추고 resize
window.addEventListener("resize", () => {
  setPlotHeight();
  Plotly.Plots.resize(plotDiv);
});

// 최초 실행
draw().catch(console.error);
</script>

</body>
</html>
