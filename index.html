<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blast Damage Map Viewer</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #plot { width: 100%; max-width: 900px; height: 600px; }
    label { margin-right: 20px; }
  </style>
</head>
<body>

<h2>Spatially Averaged Blast Damage Map</h2>

<label>
TNT charge:
<select id="charge"></select>
</label>

<label>
Threshold:
<input type="range" id="thr" min="0" max="1" step="0.01" value="0.50">
<span id="thrVal">0.50</span>
</label>

<p id="info"></p>

<div id="plot"></div>

<script>
const chargeSel = document.getElementById("charge");
const thr = document.getElementById("thr");
const thrVal = document.getElementById("thrVal");
const info = document.getElementById("info");
const plotDiv = document.getElementById("plot");

const files = [
  "m0p1","m0p2","m0p3","m0p4","m0p5",
  "m0p6","m0p7","m0p8","m0p9","m1p0"
];

files.forEach(f => {
  const opt = document.createElement("option");
  opt.value = f;
  opt.text = f.replace("m","").replace("p",".") + " kg";
  chargeSel.appendChild(opt);
});

async function loadCSV(name) {
  const r = await fetch(`data/${name}.csv`);
  const text = await r.text();
  const rows = text.trim().split(/\r?\n/);
  const head = rows[0].split(",");
  const ix = head.indexOf("x_cm");
  const iy = head.indexOf("y_cm");
  const id = head.indexOf("damage");

  const data = rows.slice(1).map(r => r.split(",").map(Number));
  const xs = [...new Set(data.map(r => r[ix]))].sort((a,b)=>a-b);
  const ys = [...new Set(data.map(r => r[iy]))].sort((a,b)=>a-b);

  const z = ys.map(() => xs.map(() => null));
  data.forEach(r => {
    z[ys.indexOf(r[iy])][xs.indexOf(r[ix])] = r[id];
  });

  return {xs, ys, z};
}

function mask(z, t) {
  return z.map(row =>
    row.map(v => v == null ? null : (v >= t ? 1 : 0))
  );
}

async function draw() {
  thrVal.textContent = Number(thr.value).toFixed(2);
  const {xs, ys, z} = await loadCSV(chargeSel.value);
  const m = mask(z, Number(thr.value));

  Plotly.newPlot(plotDiv, [
    {
      type: "heatmap",
      x: xs,
      y: ys,
      z: z,
      colorscale: [
        [0.0, "rgb(255,255,255)"],
        [1.0, "rgb(0,0,0)"]
      ],
      zmin: 0,
      zmax: 1,
      colorbar: { title: "Damage" }
    },
    {
      type: "heatmap",
      x: xs,
      y: ys,
      z: m,
      showscale: false,
      colorscale: [
        [0, "rgba(0,0,0,0)"],
        [0.5, "rgba(255,0,0,0.5)"],
        [1, "rgba(255,0,0,0.5)"]
      ]
    }
  ], {
    xaxis: { title: "X-coordinate (cm)" },
    yaxis: { title: "Y-coordinate (cm)", autorange: "reversed" },
    margin: { l: 80, r: 20, t: 20, b: 60 }
  });
}

chargeSel.onchange = draw;
thr.oninput = draw;
draw();
</script>

</body>
</html>
