<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Blast Damage Map Viewer</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #plot { width: 100%; max-width: 900px; height: 900px; }
    label { margin-right: 20px; }
  </style>
</head>
<body>

<h2>Spatially Averaged Blast Damage Map</h2>

<label>
TNT charge:
<select id="charge"></select>
</label>

<label>
Threshold:
<input type="range" id="thr" min="0" max="1" step="0.01" value="0.50">
<span id="thrVal">0.50</span>
</label>

<div id="plot"></div>

<script>
const chargeSel = document.getElementById("charge");
const thr = document.getElementById("thr");
const thrVal = document.getElementById("thrVal");
const plotDiv = document.getElementById("plot");

// ✅ 축 범위 (cm): 요청대로 고정
const X_RANGE = [-5, 50];
const Y_RANGE = [5, 105];

const files = [
  "m0p1","m0p2","m0p3","m0p4","m0p5",
  "m0p6","m0p7","m0p8","m0p9","m1p0"
];

files.forEach(f => {
  const opt = document.createElement("option");
  opt.value = f;
  opt.text = f.replace("m","").replace("p",".") + " kg";
  chargeSel.appendChild(opt);
});

async function loadCSV(name) {
  const r = await fetch(`data/${name}.csv`);
  if (!r.ok) throw new Error(`Cannot load data/${name}.csv`);
  const text = await r.text();

  const rows = text.trim().split(/\r?\n/);
  const head = rows[0].split(",");
  const ix = head.indexOf("x_cm");
  const iy = head.indexOf("y_cm");
  const id = head.indexOf("damage");
  if (ix < 0 || iy < 0 || id < 0) {
    throw new Error("CSV must have columns: x_cm,y_cm,damage");
  }

  const data = rows.slice(1).map(r => r.split(",").map(Number));
  const xs = [...new Set(data.map(r => r[ix]))].sort((a,b)=>a-b);
  const ys = [...new Set(data.map(r => r[iy]))].sort((a,b)=>a-b);

  const z = ys.map(() => xs.map(() => null));
  data.forEach(r => {
    const x = r[ix], y = r[iy], d = r[id];
    if (Number.isFinite(x) && Number.isFinite(y) && Number.isFinite(d)) {
      z[ys.indexOf(y)][xs.indexOf(x)] = d;
    }
  });

  return {xs, ys, z};
}

function mask(z, t) {
  return z.map(row =>
    row.map(v => (v == null || Number.isNaN(v)) ? null : (v >= t ? 1 : 0))
  );
}

async function draw() {
  thrVal.textContent = Number(thr.value).toFixed(2);

  const {xs, ys, z} = await loadCSV(chargeSel.value);
  const t = Number(thr.value);
  const m = mask(z, t);

  Plotly.newPlot(plotDiv, [
    // base damage map: 0 white, 1 black
    {
      type: "heatmap",
      x: xs,
      y: ys,
      z: z,
      colorscale: [
        [0.0, "rgb(255,255,255)"],
        [1.0, "rgb(0,0,0)"]
      ],
      zmin: 0,
      zmax: 1,
      colorbar: { title: "Damage" }
    },
    // overlay: threshold exceed = red
    {
      type: "heatmap",
      x: xs,
      y: ys,
      z: m,
      showscale: false,
      zmin: 0,
      zmax: 1,
      colorscale: [
        [0.0, "rgba(0,0,0,0)"],
        [1.0, "rgba(255,0,0,0.55)"]
      ]
    }
  ], {
    xaxis: {
      title: "X-coordinate (cm)",
      range: X_RANGE,
      tickmode: "linear",
      tick0: -5,
      dtick: 5,
      showgrid: true,
      gridcolor: "rgba(0,0,0,0.15)"
    },
    yaxis: {
      title: "Y-coordinate (cm)",
      range: Y_RANGE,
      tickmode: "linear",
      tick0: 5,
      dtick: 10,
      showgrid: true,
      gridcolor: "rgba(0,0,0,0.15)",
      scaleanchor: "x",
      scaleratio: 1
    },
    margin: { l: 80, r: 20, t: 20, b: 60 }
  }, {responsive: true});
}

chargeSel.onchange = () => draw().catch(e => console.error(e));
thr.oninput = () => draw().catch(e => console.error(e));
draw().catch(e => console.error(e));
</script>

</body>
</html>
